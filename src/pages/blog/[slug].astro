---
import Base from '../../layouts/Base.astro';
import BaseLink from '../../components/BaseLink.astro';
import { supabase } from '../../lib/supabase';

// 1. Tell Astro which slugs to build at *build time*
export async function getStaticPaths() {
  const { data: posts, error } = await supabase
    .from('posts')
    .select('slug');

  if (error) {
    throw error;
  }

  if (!posts || posts.length === 0) {
    return [];
  }

  // posts should be an array of rows like { slug: 'my-post' }
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

// 2. For each generated page, we get `slug` from Astro.params
const { slug } = Astro.params;

const { data: post, error: postError } = await supabase
  .from('posts')
  .select('*')
  .eq('slug', slug)
  .single();

if (postError) {
  // You could log or report this if you want
  // console.error('Error loading post:', postError);
}
---

<Base title={post?.title ?? 'Post not found'}>
  <div class="mb-6">
    <BaseLink href="blog/" class="text-sm text-zinc-500 hover:underline">
      ‚Üê Back to Blog
    </BaseLink>
  </div>

  {post ? (
    <>
      <h1 class="text-3xl font-semibold">{post.title}</h1>
      <article class="prose prose-zinc mt-6" set:html={post.content} />
    </>
  ) : (
    <p>Post not found.</p>
  )}
</Base>
